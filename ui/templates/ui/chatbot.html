{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>TherapyZ</title>
</head>

<body>
    <nav id="sidebar">
        <div class="float-top">
            <div class="sidebar-controls">
                <button class="new-chat"><i class="fa fa-plus"></i> New chat</button>
                <button class="hide-sidebar"><i class="fa fa-chevron-left"></i></button>
            </div>
            <ul class="conversations">
                {% for conversation in conversations %}
                <li>
                    <button class="conversation-button" data-id="{{ conversation.id }}">
                        <i class="fa fa-message fa-regular"></i> {{ conversation.title }}
                    </button>
                    <div class="fade"></div>
                    <div class="edit-buttons">
                        <button class="delete-conversation" data-id="{{ conversation.id }}"><i class="fa fa-trash"></i></button>
                    </div>
                </li>
                {% empty %}
                <li>No conversations yet.</li>
                {% endfor %}
            </ul>
        </div>
    </nav>

    <main>
        <div class="view new-chat-view">
            <div class="logo"><br>
                <small>Merhaba {{ user.username }}, TherapyZ' e hoşgeldin!</small>
            </div>
        </div>

        <div id="response-container">
            <!-- Mesajlar buraya gelecek -->
        </div>

        <div id="message-form">
            <div class="message-wrapper">
                <textarea id="message" rows="1" placeholder="Send a message"></textarea>
                <button class="send-button"><i class="fa fa-paper-plane"></i></button>
            </div>
        </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            let currentConversationId = null;
            let isNewChat = true;

            // Yeni sohbet başlatma
            $(".new-chat").on("click", function() {
                currentConversationId = null;
                isNewChat = true;
                $("#response-container").empty();
                $("#message").prop("disabled", false).focus();
                $(".conversation-button").removeClass("active");
                $(".new-chat-view").show();
            });

            // Eski sohbeti görüntüleme
            $(".conversation-button").on("click", function() {
                const button = $(this);
                const conversationId = button.data("id");
                currentConversationId = conversationId; // Aktif sohbet ID'sini güncelle
                isNewChat = false;

                // Aktif sohbeti vurgula
                $(".conversation-button").removeClass("active");
                button.addClass("active");
                
                // Yeni sohbet görünümünü gizle
                $(".new-chat-view").hide();

                // Mesaj alanını aktif et
                $("#message").prop("disabled", false).focus();

                // Sohbet geçmişini yükle
                $("#response-container").empty();
                fetch(`/conversation/${conversationId}/messages/`)
                    .then(response => response.json())
                    .then(data => {
                        data.messages.forEach(message => {
                            const isUser = message.sender !== "ChatBot";
                            $("#response-container").append(`
                                <div class="message ${isUser ? 'user' : 'assistant'} message">
                                    ${!isUser ? `<div class="identity">
                                        <i class="assistant-message-icon user-icon">B</i>
                                    </div>` : ''}
                                    <div class="content">
                                        <p>${message.message}</p>
                                    </div>
                                    ${isUser ? `<div class="identity">
                                        <i class="user-message-icon user-icon">${message.sender.charAt(0).toUpperCase()}</i>
                                    </div>` : ''}
                                </div>
                            `);
                        });
                        $("#response-container").scrollTop($("#response-container")[0].scrollHeight);
                    });
            });

            // Sohbet silme
            $(".delete-conversation").on("click", function(e) {
                e.stopPropagation();
                const conversationId = $(this).data("id");
                if (confirm("Bu sohbeti silmek istediğinizden emin misiniz?")) {
                    $.ajax({
                        url: `/delete_conversation/${conversationId}/`,
                        method: "POST",
                        success: function() {
                            $(`.conversation-button[data-id="${conversationId}"]`).closest("li").remove();
                            if (currentConversationId === conversationId) {
                                $(".new-chat").click();
                            }
                        },
                        error: function() {
                            alert("Sohbet silinirken bir hata oluştu.");
                        }
                    });
                }
            });

            // Mesaj gönderme
            $(".send-button").on("click", function () {
                var message = $("#message").val().trim();
                if (message) {
                    // Kullanıcı mesajını hemen göster
                    $("#response-container").append(`
                        <div class="message user message">
                            <div class="content">
                                <p>${message}</p>
                            </div>
                            <div class="identity">
                                <i class="user-message-icon user-icon">${'{{ user.username }}'.charAt(0).toUpperCase()}</i>
                            </div>
                        </div>
                    `);

                    // Mesaj kutusunu temizle ve scroll'u en alta çek
                    $("#message").val("");
                    $("#response-container").scrollTop($("#response-container")[0].scrollHeight);

                    // API'ye istek gönder
                    $.ajax({
                        url: "{% url 'chatbot_reply' %}",
                        method: "POST",
                        data: { 
                            message: message,
                            conversation_id: currentConversationId
                        },
                        success: function (response) {
                            // Konuşma ID'sini güncelle
                            currentConversationId = response.conversation_id;
                            
                            // Yeni sohbet ise sidebar'a ekle
                            if (isNewChat) {
                                isNewChat = false;
                                const newConversation = `
                                    <li>
                                        <button class="conversation-button" data-id="${response.conversation_id}">
                                            <i class="fa fa-message fa-regular"></i> ${message.substring(0, 50)}...
                                        </button>
                                        <div class="fade"></div>
                                        <div class="edit-buttons">
                                            <button class="delete-conversation" data-id="${response.conversation_id}">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </div>
                                    </li>
                                `;
                                $(".conversations").prepend(newConversation);
                                
                                // Yeni eklenen sohbet butonuna click event listener ekle
                                $(".conversation-button").first().on("click", function() {
                                    const button = $(this);
                                    currentConversationId = button.data("id");
                                    isNewChat = false;
                                    $(".conversation-button").removeClass("active");
                                    button.addClass("active");
                                    $(".new-chat-view").hide();
                                });
                                
                                // Yeni eklenen silme butonuna click event listener ekle
                                $(".delete-conversation").first().on("click", function(e) {
                                    e.stopPropagation();
                                    const conversationId = $(this).data("id");
                                    if (confirm("Bu sohbeti silmek istediğinizden emin misiniz?")) {
                                        $.ajax({
                                            url: `/delete_conversation/${conversationId}/`,
                                            method: "POST",
                                            success: function() {
                                                $(`.conversation-button[data-id="${conversationId}"]`).closest("li").remove();
                                                if (currentConversationId === conversationId) {
                                                    $(".new-chat").click();
                                                }
                                            },
                                            error: function() {
                                                alert("Sohbet silinirken bir hata oluştu.");
                                            }
                                        });
                                    }
                                });
                            }

                            // Bot cevabını göster
                            $("#response-container").append(`
                                <div class="message assistant message">
                                    <div class="identity">
                                        <i class="assistant-message-icon user-icon">B</i>
                                    </div>
                                    <div class="content">
                                        <p>${response.bot_reply}</p>
                                    </div>
                                </div>
                            `);

                            // Scroll'u en alta çek
                            $("#response-container").scrollTop($("#response-container")[0].scrollHeight);
                        },
                        error: function (xhr, status, error) {
                            let errorMessage = 'Bir hata oluştu.';
                            if (xhr.responseJSON && xhr.responseJSON.error) {
                                errorMessage = xhr.responseJSON.error;
                            }
                            
                            $("#response-container").append(`
                                <div class="message error">
                                    <div class="content">
                                        <p style="color: red;">Hata: ${errorMessage}</p>
                                    </div>
                                </div>
                            `);
                            
                            console.error('Error:', error);
                        }
                    });
                }
            });

            $("#message").on("keypress", function (event) {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    $(".send-button").click();
                }
            });

            // Sayfa yüklendiğinde yeni sohbet başlat
            $(".new-chat").click();
        });
    </script>
</body>
</html>