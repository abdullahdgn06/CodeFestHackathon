{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>ChatGPT Clone</title>
</head>

<body>
    <nav id="sidebar">
        <div class="float-top">
            <div class="sidebar-controls">
                <a style="text-decoration: none;" href="{% url 'newchatbot' %}" class="yenibuton new-chat"><i class="fa fa-plus"></i> New chat</a>
                <button class="hide-sidebar"><i class="fa fa-chevron-left"></i></button>
            </div>
            <ul class="conversations">
                {% for conversation in conversations %}
                <li>
                    <button class="conversation-button" data-id="{{ conversation.id }}">
                        <i class="fa fa-message fa-regular"></i> {{ conversation.title }}
                    </button>
                    <div class="fade"></div>
                    <div class="edit-buttons">
                        <button><i class="fa fa-edit"></i></button>
                        <button class="delete-conversation" data-id="{{ conversation.id }}"><i class="fa fa-trash"></i></button>
                    </div>
                </li>
                {% empty %}
                <li>No conversations yet.</li>
                {% endfor %}
            </ul>
        </div>
    </nav>
    <main>
        <div class="view new-chat-view">
            <div class="logo">
                <br>
                TherapyZ
            </div>
        </div>


        <div class="view conversation-view" id="messages-container">
            <div class="model-name">
                <i class="fa fa-brain"></i> Select a conversation
            </div>
            <!-- Mesajlar buraya gelecek -->
        </div>

        <div id="message-form">
            <div class="message-wrapper">
                <textarea id="message" rows="1" placeholder="Send a message"></textarea>
                <button class="send-button"><i class="fa fa-paper-plane"></i></button>
            </div>
        </div>
    </main>
    <script>
        // Konuşma butonuna tıklanınca AJAX isteği gönderecek
        document.querySelectorAll('.conversation-button').forEach(function(button) {
            button.addEventListener('click', function() {
                var conversationId = button.getAttribute('data-id');
                fetch(`/conversation/${conversationId}/messages/`)
                    .then(response => response.json())
                    .then(data => {
                        // Gelen mesajları bir değişkende sakla
                        var messages = data.messages;
        
                        // Mesajları HTML formatında işlemek için bir değişken oluştur
                        var messagesHTML = '';
        
                        // Eğer mesaj varsa
                        if (messages.length > 0) {
                            messages.forEach(function(message) {
                                // Mesajı HTML olarak formatla
                                var messageClass = message.sender === "ChatBot" ? "assistant message" : "user message";
                                
                                // ChatBot ise identity mesajdan önce, diğer kullanıcılar için mesajın class'ına "user.message" ekle
                                var messageHTML = '';
                                if (message.sender === "ChatBot") {
                                    // ChatBot için identity mesajdan önce
                                    messageHTML = `
                                        <div class="message ${messageClass}">
                                            <div class="identity">
                                                <i class="${messageClass}-icon user-icon">${message.sender.charAt(0).toUpperCase()}</i>
                                            </div>
                                            <div class="content">
                                                <p>${message.message}</p>
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    // Diğer kullanıcılar için identity mesajdan sonra
                                    // Ek olarak message class'ına "user.message" ekliyoruz
                                    messageHTML = `
                                        <div class="message ${messageClass} user-message">
                                            <div class="content">
                                                <p>${message.message}</p>
                                            </div>
                                            <div class="identity">
                                                <i class="${messageClass}-icon user-icon">${message.sender.charAt(0).toUpperCase()}</i>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                // HTML formatında mesajı messagesHTML'e ekle
                                messagesHTML += messageHTML;
                            });
                        } else {
                            // Eğer mesaj yoksa, mesaj olmadığı bilgisini ekle
                            messagesHTML = '<p>No messages yet.</p>';
                        }
        
                        // Mesajları ilgili alanla HTML olarak güncelle
                        var messagesContainer = document.getElementById('messages-container');
                        messagesContainer.innerHTML = messagesHTML;
                    })
                    .catch(error => {
                        console.error('Error fetching messages:', error);
                    });
            });
        });
    </script>
    
    
    
    <script src="{% static 'script.js' %}"></script>
</body>

</html>