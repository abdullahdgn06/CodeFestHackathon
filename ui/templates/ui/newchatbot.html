{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>ChatGPT Clone</title>
</head>

<body>
    <nav id="sidebar">
        <div class="float-top">
            <div class="sidebar-controls">
                <button class="new-chat"><i class="fa fa-plus"></i> New chat</button>
                <button class="hide-sidebar"><i class="fa fa-chevron-left"></i></button>
            </div>
            <ul class="conversations">
                {% for conversation in conversations %}
                <li>
                    <a style="text-decoration: none;" class="yenibuton conversation-button" href="{% url 'chatbot' %}">
                        <i class="fa fa-message fa-regular"></i> {{ conversation.title }}
                    </a>
                    <div class="fade"></div>
                    <div class="edit-buttons">
                        <button><i class="fa fa-edit"></i></button>
                        <button class="delete-conversation" data-id="{{ conversation.id }}"><i
                                class="fa fa-trash"></i></button>
                    </div>
                </li>
                {% empty %}
                <li>No conversations yet.</li>
                {% endfor %}
            </ul>
        </div>
    </nav>

    <main>
        <div class="view new-chat-view">
            <div class="logo"><br>
                <small>Merhaba {{ user.username }}, TherapyZ' e hoşgeldin!</small>
            </div>
        </div>
        
        <!-- Container for showing the response -->
        <div id="response-container">
            <!-- Responses will appear here -->
        </div>

        <div id="message-form">
            <div class="message-wrapper">
                <textarea id="message" rows="1" placeholder="Send a message"></textarea>
                <button class="send-button"><i class="fa fa-paper-plane"></i></button>
            </div>
        </div>


    </main>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static 'script.js' %}"></script>

    <script>
        $(document).ready(function () {
            $(".send-button").on("click", function () {
                var message = $("#message").val().trim();

                if (message) {
                    // Display the sent message
                    $("#response-container").append(`<div class="user-message">${message}</div>`);
                    $("#message").val(""); // Clear the message input

                    // Prepare the data for the API request
                    var data = {
                        "model": "turkish-llama-8b-instruct-v0.1",
                        "messages": [
                            {
                                "role": "system",
                                "content": "Sen uzman bir psikologsun. Türkçe konuşuyorsun. Terapi yapıyorsun. Adım adım sohbeti ilerlet ve öneri ver. Hastalarına en uygun cevapları veriyorsun."
                            },
                            {
                                "role": "user",
                                "content": message
                            }
                        ],
                        "temperature": 0.7,
                        "max_tokens": -1,
                        "stream": false
                    };

                    // Send the message via AJAX
                    $.ajax({
                        url: "http://10.95.48.119:1234/v1/chat/completions",  // Your external API endpoint
                        method: "POST",
                        contentType: "application/json",  // Send as JSON
                        data: JSON.stringify(data),  // Stringify the JSON data
                        success: function (response) {
                            // Check the response structure and extract the bot's reply
                            if (response && response.choices && response.choices[0]) {
                                var botResponse = response.choices[0].message.content;
                                $("#response-container").append(`<div class="bot-response">${botResponse}</div>`);
                            } else {
                                $("#response-container").append('<div class="bot-response">Sorry, no valid response from the bot.</div>');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.log("Error:", error);
                            $("#response-container").append('<div class="bot-response">Sorry, something went wrong.</div>');
                        }
                    });
                }
            });

            // Optional: Add Enter key to send message
            $("#message").on("keypress", function (event) {
                if (event.key === "Enter") {
                    $(".send-button").click();
                }
            });
        });
    </script>
</body>

</html>